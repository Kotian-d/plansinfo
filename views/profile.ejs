<!DOCTYPE html>
<html>
  <head>
    <title>Profile Page</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="/css/profile.css" />
  </head>
  <body>
    <%- include('partials/navbar') %>

    <div class="container profile-container">
      <% if (successMsg && successMsg.length > 0) { %>
      <div class="alert alert-success alert-dismissible" role="alert">
        <button
          type="button"
          class="close"
          data-dismiss="alert"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
        <%= successMsg %>
      </div>
      <% } %> <% if (errorMsg && errorMsg.length > 0) { %>
      <div class="alert alert-danger alert-dismissible" role="alert">
        <button
          type="button"
          class="close"
          data-dismiss="alert"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
        <%= errorMsg %>
      </div>
      <% } %>

      <h2 class="text-center">User Profile</h2>

      <div class="text-center" style="margin-bottom: 20px">
        <img
          src="https://media.istockphoto.com/id/1300845620/vector/user-icon-flat-isolated-on-white-background-user-symbol-vector-illustration.jpg?s=612x612&w=0&k=20&c=yBeyba0hUkh14_jgv1OKqIH0CCSWU_4ckRkAoy2p73o="
          alt="User Avatar"
          class="img-circle"
          style="width: 120px; height: 120px"
        />
      </div>

      <dl class="dl-horizontal">
        <dt>Username:</dt>
        <dd><%= user.username %></dd>

        <dt>Mobile:</dt>
        <dd><%= user.mobile %></dd>

        <dt>API Key:</dt>
        <dd><div class="apikey"><%= user.apikey %></div></dd>

        <dt>Whitelisted IPs:</dt>
        <dd>
          <div class="ip-list" id="ipList">
            <% if (user.whitelistedIPs && user.whitelistedIPs.length > 0) { %>
              <% user.whitelistedIPs.forEach(function(ip) { %>
                <span class="ip-tag">
                  <%= ip %>
                  <span class="remove-ip" onclick="removeIP('<%= ip %>')">&times;</span>
                </span>
              <% }); %>
            <% } else { %>
              <span class="text-muted">No IPs whitelisted</span>
            <% } %>
          </div>
        </dd>
      </dl>

      <hr />

      <h3>Add IP to Whitelist</h3>
      <form
        action="/profile/add-ip"
        method="POST"
        class="form-horizontal"
        id="addIPForm"
      >
        <div class="form-group">
          <label class="control-label col-sm-4" for="ipAddress"
            >IP Address:</label
          >
          <div class="col-sm-8">
            <input
              type="text"
              class="form-control"
              id="ipAddress"
              name="ipAddress"
              placeholder="e.g., 192.168.1.100 or 10.0.0.0/24"
              required
              pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?:\/(?:3[0-2]|[12]?[0-9]))?$"
              title="Enter a valid IP address (e.g., 192.168.1.1) or CIDR notation (e.g., 192.168.1.0/24)"
            />
            <small class="help-block">Enter IPv4 address or CIDR notation</small>
          </div>
        </div>
        <div class="form-group">
          <div class="col-sm-offset-4 col-sm-8">
            <button type="submit" class="btn btn-success">
              <span class="glyphicon glyphicon-plus"></span> Add IP
            </button>
          </div>
        </div>
      </form>

      <hr />

      <h3>Change Password</h3>
      <form
        action="/profile/change-password"
        method="POST"
        class="form-horizontal"
        id="passwordChangeForm"
      >
        <div class="form-group">
          <label class="control-label col-sm-4" for="currentPassword"
            >Current Password:</label
          >
          <div class="col-sm-8">
            <input
              type="password"
              class="form-control"
              id="currentPassword"
              name="currentPassword"
              required
            />
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="newPassword"
            >New Password:</label
          >
          <div class="col-sm-8">
            <input
              type="password"
              class="form-control"
              id="newPassword"
              name="newPassword"
              required
              minlength="6"
            />
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="confirmPassword"
            >Confirm New Password:</label
          >
          <div class="col-sm-8">
            <input
              type="password"
              class="form-control"
              id="confirmPassword"
              name="confirmPassword"
              required
              minlength="6"
            />
          </div>
        </div>
        <div class="form-group">
          <div class="col-sm-offset-4 col-sm-8">
            <button type="submit" class="btn btn-primary">
              Change Password
            </button>
          </div>
        </div>
      </form>
    </div>

    <script>
      // Function to remove IP from whitelist
      function removeIP(ip) {
        if (confirm('Are you sure you want to remove ' + ip + ' from whitelist?')) {
          // Create a form and submit
          var form = document.createElement('form');
          form.method = 'POST';
          form.action = '/profile/remove-ip';
          
          var input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'ipAddress';
          input.value = ip;
          
          form.appendChild(input);
          document.body.appendChild(form);
          form.submit();
        }
      }

      // Client-side password match validation
      document.getElementById('passwordChangeForm').addEventListener('submit', function(e) {
        var newPassword = document.getElementById('newPassword').value;
        var confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
          e.preventDefault();
          alert('New password and confirm password do not match!');
        }
      });
    </script>

    <%- include('partials/footer') %>
  </body>
</html>
